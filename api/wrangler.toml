name = "clw-cash-api"
main = "src/index.ts"
compatibility_date = "2026-02-01"
compatibility_flags = ["nodejs_compat"]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "clw-cash-db"
database_id = "e09e3b97-6ae9-4778-b029-e7f2f5bf24f8"  # Fill after: wrangler d1 create clw-cash-db
migrations_dir = "migrations"

# KV Namespaces — fill IDs after creating with:
#   npx wrangler kv namespace create KV_TICKETS
#   npx wrangler kv namespace create KV_RATE_LIMIT
[[kv_namespaces]]
binding = "KV_TICKETS"
id = "419b8e6d63084afaaa245d9b3fb6faf7"

[[kv_namespaces]]
binding = "KV_RATE_LIMIT"
id = "969b388a46454ae1886d8c37b3e54ee2"

# Environment variables (non-secret)
[vars]
ENCLAVE_BASE_URL = "http://127.0.0.1:7000"
TICKET_TTL_SECONDS = "90"
SESSION_TTL_SECONDS = "3600"
CHALLENGE_TTL_SECONDS = "300"
RATE_LIMIT_WINDOW_MS = "60000"
RATE_LIMIT_PER_USER = "60"
RATE_LIMIT_PER_IDENTITY_SIGN = "20"
ALLOWED_ORIGINS = "http://localhost:5173"

# Secrets (set via: wrangler secret put <NAME>)
# INTERNAL_API_KEY
# TICKET_SIGNING_SECRET
# SESSION_SIGNING_SECRET
# TELEGRAM_BOT_TOKEN
# TELEGRAM_BOT_USERNAME
# EV_API_KEY

# ── Production ──────────────────────────────────────────────
[env.production]
name = "clw-cash-api"

[env.production.vars]
ENCLAVE_BASE_URL = "https://clw-cash-signer.app-366535fdf2b7.enclave.evervault.com"
TICKET_TTL_SECONDS = "90"
SESSION_TTL_SECONDS = "3600"
CHALLENGE_TTL_SECONDS = "300"
RATE_LIMIT_WINDOW_MS = "60000"
RATE_LIMIT_PER_USER = "60"
RATE_LIMIT_PER_IDENTITY_SIGN = "20"
ALLOWED_ORIGINS = "https://pay.clw.cash"

[[env.production.d1_databases]]
binding = "DB"
database_name = "clw-cash-db"
database_id = "e09e3b97-6ae9-4778-b029-e7f2f5bf24f8"
migrations_dir = "migrations"

[[env.production.kv_namespaces]]
binding = "KV_TICKETS"
id = "419b8e6d63084afaaa245d9b3fb6faf7"

[[env.production.kv_namespaces]]
binding = "KV_RATE_LIMIT"
id = "969b388a46454ae1886d8c37b3e54ee2"

# Custom domain — after first deploy, run:
#   npx wrangler deploy --env production
#   Then in Cloudflare Dashboard > Workers & Pages > clw-cash-api > Settings > Domains & Routes
#   Add custom domain: api.clw.cash (Cloudflare auto-creates the DNS record)
